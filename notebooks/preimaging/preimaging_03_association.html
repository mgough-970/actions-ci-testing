<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   NIRCam Preimaging: Pipeline Stage 3 â€” STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <link href="../ifu_optimal/ifu_optimal.html" rel="next" title="IFU Optimal Spectral Extraction"/>
  <link href="preimaging_01_mirage.html" rel="prev" title="NIRCam Preimaging: MIRAGE Simulations"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
            James Webb Space Telescope Data Analysis Tool Notebooks
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MOS Spectroscopy
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Example Notebook
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../example_notebook/example_notebook.html">
            Draft: Notebook title
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           IFU Continuum Fit
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           PSF Matched Photometry
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI IFU in the LMC
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Preimaging
          </span>
         </p>
         <ul class="current nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="preimaging_02_calwebb.html">
            NIRCam Preimaging: Pipeline Stages 1, 2
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="preimaging_01_mirage.html">
            NIRCam Preimaging: MIRAGE Simulations
           </a>
          </li>
          <li class="toctree-l1 current active">
           <a class="current reference internal" href="#">
            NIRCam Preimaging: Pipeline Stage 3
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Optimal Extraction
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           SOSS Transient Spectroscopy
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
            SOSS Transit Spectroscopy
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           PSF Photometry
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Specviz Interaction
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           ASDF Example
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Composite Model Fitting
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS AMI Binary
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
            NIRISS AMI: MIRAGE Simulations
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
            NIRISS AMI: Pipeline
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Aperture Photometry
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec MAST Query
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI LRS Extraction
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Transient Spectroscopy
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://mybinder.org/v2/gh/therealzoidberg/actions-ci-testing/main?urlpath=tree/notebooks/notebooks/preimaging/preimaging_03_association.ipynb" title="Launch on Binder">
             <span class="headerbtn__icon-container">
              <img src="../../_static/images/logo_binder.svg"/>
             </span>
             <span class="headerbtn__text-container">
              Binder
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/therealzoidberg/actions-ci-testing/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/therealzoidberg/actions-ci-testing//issues/new?title=Issue%20on%20page%20%2Fnotebooks/preimaging/preimaging_03_association.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/preimaging/preimaging_03_association.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h1 nav-item toc-entry">
          <a class="reference internal nav-link" href="#">
           NIRCam Preimaging: Pipeline Stage 3
          </a>
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#introduction">
             Introduction
            </a>
           </li>
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#setting-things-up">
             Setting things up
            </a>
            <ul class="nav section-nav flex-column">
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#this-next-cell-only-needs-to-be-executed-for-this-version-of-the-notebook-which-only-runs-the-pipeline-for-one-pointing-due-to-file-size-limitations-you-can-comment-out-with-more-than-one-pointing-or-set-of-exposures">
               This next cell only needs to be executed for this version of the notebook, which only runs the pipeline for one pointing due to file size limitations. You can comment out with more than one pointing or set of exposures.
              </a>
             </li>
             <li class="toc-h3 nav-item toc-entry">
              <a class="reference internal nav-link" href="#save-detector-list-to-an-association-json-file">
               Save Detector List to an Association (JSON file)
              </a>
             </li>
            </ul>
           </li>
          </ul>
         </li>
         <li class="toc-h1 nav-item toc-entry">
          <a class="reference internal nav-link" href="#execute-the-third-stage-of-the-nircam-pipeline">
           Execute the third stage of the NIRCam pipeline
          </a>
          <ul class="visible nav section-nav flex-column">
           <li class="toc-h2 nav-item toc-entry">
            <a class="reference internal nav-link" href="#load-data-into-imviz">
             Load data into Imviz
            </a>
           </li>
          </ul>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         NIRCam Preimaging: Pipeline Stage 3
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#">
              NIRCam Preimaging: Pipeline Stage 3
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#introduction">
                Introduction
               </a>
              </li>
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#setting-things-up">
                Setting things up
               </a>
               <ul class="nav section-nav flex-column">
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#this-next-cell-only-needs-to-be-executed-for-this-version-of-the-notebook-which-only-runs-the-pipeline-for-one-pointing-due-to-file-size-limitations-you-can-comment-out-with-more-than-one-pointing-or-set-of-exposures">
                  This next cell only needs to be executed for this version of the notebook, which only runs the pipeline for one pointing due to file size limitations. You can comment out with more than one pointing or set of exposures.
                 </a>
                </li>
                <li class="toc-h3 nav-item toc-entry">
                 <a class="reference internal nav-link" href="#save-detector-list-to-an-association-json-file">
                  Save Detector List to an Association (JSON file)
                 </a>
                </li>
               </ul>
              </li>
             </ul>
            </li>
            <li class="toc-h1 nav-item toc-entry">
             <a class="reference internal nav-link" href="#execute-the-third-stage-of-the-nircam-pipeline">
              Execute the third stage of the NIRCam pipeline
             </a>
             <ul class="visible nav section-nav flex-column">
              <li class="toc-h2 nav-item toc-entry">
               <a class="reference internal nav-link" href="#load-data-into-imviz">
                Load data into Imviz
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="nircam-preimaging-pipeline-stage-3">
          <h1>
           NIRCam Preimaging: Pipeline Stage 3
           <a class="headerlink" href="#nircam-preimaging-pipeline-stage-3" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           <strong>
            Use case:
           </strong>
           Running JWST Pipeline on NIRCam Preimaging Simulations.
           <br/>
           <strong>
            Data:
           </strong>
           JWST simulated NIRCam data from MIRAGE; LMC.
           <br/>
           <strong>
            Tools:
           </strong>
           jwst.
           <br/>
           <strong>
            Cross-intrument:
           </strong>
           NIRCam.
           <br/>
           <strong>
            Documentation:
           </strong>
           This notebook is part of a STScIâ€™s larger
           <a class="reference external" href="https://jwst-docs.stsci.edu/jwst-post-pipeline-data-analysis">
            post-pipeline Data Analysis Tools Ecosystem
           </a>
           .
           <br/>
          </p>
          <section id="introduction">
           <h2>
            Introduction
            <a class="headerlink" href="#introduction" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            In this Notebook we show how to create the association needed to execute calwebb_image3 and how to run calwebb_image3.
           </p>
          </section>
          <section id="setting-things-up">
           <h2>
            Setting things up
            <a class="headerlink" href="#setting-things-up" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span> 
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shapely.ops</span> <span class="k">as</span> <span class="nn">so</span>

<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Image3Pipeline</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span> <span class="k">as</span> <span class="n">leopolygon</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">PatchCollection</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">path</span><span class="o">=</span><span class="s1">'./.'</span> <span class="c1"># This is the working directory.</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>/home/runner/work/actions-ci-testing/actions-ci-testing/notebooks/preimaging
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Change parameters here</span>
<span class="n">filtname</span> <span class="o">=</span> <span class="s1">'f150w'</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Gather the F150W *cal.fits files back in the working directory</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">filter_pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="s1">'*_cal.fits'</span><span class="p">)</span> 
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">filter_pattern</span><span class="p">)[:]</span> 
<span class="n">namelist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">outlist</span> <span class="o">=</span> <span class="p">[]</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="this-next-cell-only-needs-to-be-executed-for-this-version-of-the-notebook-which-only-runs-the-pipeline-for-one-pointing-due-to-file-size-limitations-you-can-comment-out-with-more-than-one-pointing-or-set-of-exposures">
            <h3>
             This next cell only needs to be executed for this version of the notebook, which only runs the pipeline for one pointing due to file size limitations. You can comment out with more than one pointing or set of exposures.
             <a class="headerlink" href="#this-next-cell-only-needs-to-be-executed-for-this-version-of-the-notebook-which-only-runs-the-pipeline-for-one-pointing-due-to-file-size-limitations-you-can-comment-out-with-more-than-one-pointing-or-set-of-exposures" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[:]</span><span class="o">+</span><span class="n">files</span><span class="p">[:]</span>
<span class="n">files</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>[]
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># We convert corner pixel coordinates to world coordinates </span>
<span class="n">coord</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    
    <span class="c1"># Parse the WCS keywords in the primary HDU</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">naxis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Print out the "name" of the WCS, as defined in the FITS header</span>
    <span class="c1"># print(w.wcs.name)</span>

    <span class="c1"># Three pixel coordinates of interest.</span>
    <span class="c1"># Note we've silently assumed a NAXIS=2 image here</span>
    <span class="n">pixcrd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">2048</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2048</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">)</span>
    
    <span class="c1"># Convert pixel coordinates to world coordinates</span>
    <span class="n">world</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">pixcrd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">#world = w.wcs_pix2world([[0, 0], [2048, 0], [2048, 2048], [0, 2048]], 0)</span>
    <span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">world</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># we read the input source catalogue</span>
<span class="n">pointsource_catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'./preimaging/pointsource_LMCcalField_F150W.cat'</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'ascii'</span><span class="p">)</span>
<span class="n">pointsource_ra</span> <span class="o">=</span> <span class="n">pointsource_catalog</span><span class="p">[</span><span class="s1">'x_or_RA'</span><span class="p">]</span>
<span class="n">pointsource_dec</span> <span class="o">=</span> <span class="n">pointsource_catalog</span><span class="p">[</span><span class="s1">'y_or_Dec'</span><span class="p">]</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output traceback highlight-ipythontb notranslate">
               <div class="highlight">
                <pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">FileNotFoundError</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="nn">Input In [8],</span> in <span class="ni">&lt;cell line: 2&gt;</span><span class="nt">()</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># we read the input source catalogue</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">pointsource_catalog</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">'./preimaging/pointsource_LMCcalField_F150W.cat'</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'ascii'</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">pointsource_ra</span> <span class="o">=</span> <span class="n">pointsource_catalog</span><span class="p">[</span><span class="s1">'x_or_RA'</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">pointsource_dec</span> <span class="o">=</span> <span class="n">pointsource_catalog</span><span class="p">[</span><span class="s1">'y_or_Dec'</span><span class="p">]</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/table/connect.py:62,</span> in <span class="ni">TableRead.__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span> <span class="n">units</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'units'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span> <span class="n">descriptions</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'descriptions'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">62</span> <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">64</span> <span class="c1"># For some readers (e.g., ascii.ecsv), the returned `out` class is not</span>
<span class="g g-Whitespace">     </span><span class="mi">65</span> <span class="c1"># guaranteed to be the same as the desired output `cls`.  If so,</span>
<span class="g g-Whitespace">     </span><span class="mi">66</span> <span class="c1"># try coercing to desired class without copying (io.registry.read</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span> <span class="c1"># would normally do a copy).  The normal case here is swapping</span>
<span class="g g-Whitespace">     </span><span class="mi">68</span> <span class="c1"># Table &lt;=&gt; QTable.</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span> <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/io/registry/core.py:212,</span> in <span class="ni">UnifiedInputRegistry.read</span><span class="nt">(self, cls, format, cache, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span>     <span class="nb">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_format</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>         <span class="s1">'read'</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span> <span class="n">reader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reader</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">212</span> <span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span>     <span class="c1"># User has read with a subclass where only the parent class is</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="c1"># registered.  This returns the parent class, so try coercing</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span>     <span class="c1"># to desired subclass.</span>
<span class="g g-Whitespace">    </span><span class="mi">218</span>     <span class="k">try</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/io/ascii/connect.py:18,</span> in <span class="ni">io_read</span><span class="nt">(format, filename, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>     <span class="nb">format</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">'^ascii\.'</span><span class="p">,</span> <span class="s1">''</span><span class="p">,</span> <span class="nb">format</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span>     <span class="n">kwargs</span><span class="p">[</span><span class="s1">'format'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>
<span class="ne">---&gt; </span><span class="mi">18</span> <span class="k">return</span> <span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/io/ascii/ui.py:359,</span> in <span class="ni">read</span><span class="nt">(table, guess, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">353</span>             <span class="n">new_kwargs</span><span class="p">[</span><span class="s1">'guess_html'</span><span class="p">]</span> <span class="o">=</span> <span class="n">_probably_html</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span> <span class="c1"># Get the table from guess in ``dat``.  If ``dat`` comes back as None</span>
<span class="g g-Whitespace">    </span><span class="mi">356</span> <span class="c1"># then there was just one set of kwargs in the guess list so fall</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span> <span class="c1"># through below to the non-guess way so that any problems result in a</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span> <span class="c1"># more useful traceback.</span>
<span class="ne">--&gt; </span><span class="mi">359</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">_guess</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">new_kwargs</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">fast_reader</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">360</span> <span class="k">if</span> <span class="n">dat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">361</span>     <span class="n">guess</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/io/ascii/ui.py:526,</span> in <span class="ni">_guess</span><span class="nt">(table, read_kwargs, format, fast_reader)</span>
<span class="g g-Whitespace">    </span><span class="mi">523</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">get_reader</span><span class="p">(</span><span class="o">**</span><span class="n">guess_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">525</span> <span class="n">reader</span><span class="o">.</span><span class="n">guessing</span> <span class="o">=</span> <span class="kc">True</span>
<span class="ne">--&gt; </span><span class="mi">526</span> <span class="n">dat</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">527</span> <span class="n">_read_trace</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">'kwargs'</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">guess_kwargs</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>                     <span class="s1">'Reader'</span><span class="p">:</span> <span class="n">reader</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>                     <span class="s1">'status'</span><span class="p">:</span> <span class="s1">'Success (guessing)'</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">530</span>                     <span class="s1">'dt'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> ms'</span><span class="p">})</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span> <span class="k">return</span> <span class="n">dat</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/io/ascii/core.py:1356,</span> in <span class="ni">BaseReader.read</span><span class="nt">(self, table)</span>
<span class="g g-Whitespace">   </span><span class="mi">1353</span>     <span class="n">newline</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">1355</span> <span class="c1"># Get a list of the lines (rows) in the table</span>
<span class="ne">-&gt; </span><span class="mi">1356</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputter</span><span class="o">.</span><span class="n">get_lines</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1358</span> <span class="c1"># Set self.data.data_lines to a slice of lines contain the data rows</span>
<span class="g g-Whitespace">   </span><span class="mi">1359</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_data_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/io/ascii/core.py:330,</span> in <span class="ni">BaseInputter.get_lines</span><span class="nt">(self, table, newline)</span>
<span class="g g-Whitespace">    </span><span class="mi">327</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">328</span>     <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">'read'</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">329</span>             <span class="ow">or</span> <span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span> <span class="o">+</span> <span class="s1">''</span> <span class="ow">and</span> <span class="s1">'</span><span class="se">\r</span><span class="s1">'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span> <span class="o">+</span> <span class="s1">''</span><span class="p">)):</span>
<span class="ne">--&gt; </span><span class="mi">330</span>         <span class="k">with</span> <span class="n">get_readable_fileobj</span><span class="p">(</span><span class="n">table</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span>                                   <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">332</span>             <span class="n">table</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">333</span>     <span class="k">if</span> <span class="n">newline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/contextlib.py:119,</span> in <span class="ni">_GeneratorContextManager.__enter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">117</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">119</span>     <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">121</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"generator didn't yield"</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/site-packages/astropy/utils/data.py:271,</span> in <span class="ni">get_readable_fileobj</span><span class="nt">(name_or_obj, encoding, cache, show_progress, remote_timeout, sources, http_headers)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span> <span class="k">if</span> <span class="n">is_url</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="n">name_or_obj</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>         <span class="n">name_or_obj</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">show_progress</span><span class="o">=</span><span class="n">show_progress</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>         <span class="n">timeout</span><span class="o">=</span><span class="n">remote_timeout</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>         <span class="n">http_headers</span><span class="o">=</span><span class="n">http_headers</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">271</span> <span class="n">fileobj</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">FileIO</span><span class="p">(</span><span class="n">name_or_obj</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">272</span> <span class="k">if</span> <span class="n">is_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">273</span>     <span class="n">delete_fds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>

<span class="ne">FileNotFoundError</span>: [Errno 2] No such file or directory: './preimaging/pointsource_LMCcalField_F150W.cat'
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># We plot the field of view of the simulated images (blue) on top of the source catalogue (red)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">'w'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">pointsource_ra</span><span class="p">,</span> <span class="n">pointsource_dec</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Catalog point sources'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
    <span class="n">rect1</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Polygon</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> 
                                       <span class="n">facecolor</span><span class="o">=</span><span class="s1">'blue'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect1</span><span class="p">)</span>
<span class="n">rect1</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">'Detector'</span><span class="p">)</span>

<span class="c1"># These limits correspond to the LMC </span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">80.2</span><span class="p">,</span> <span class="mf">80.8</span><span class="p">])</span> <span class="c1"># alpha</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">69.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.6</span><span class="p">])</span> <span class="c1"># delta</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'RA (degrees)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Dec (degrees)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'F150W Mosaic'</span><span class="p">)</span>
<span class="c1">#plt.axis('scaled')</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             In order to create an association for stage 3 of the pipeline, we need to check that each image contains sources from the catalog and that the images overlap in such a way that they make a continuous mosaic.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">current_detector_idx</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">current_detector</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">current_detector_coords</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">number_detectors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="n">detectors</span> <span class="o">=</span> <span class="n">files</span><span class="p">[:]</span>
<span class="n">detector_coords</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[:]</span>
<span class="n">referencia</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">finallist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">finalcoords</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_detectors</span><span class="p">):</span>
    
    <span class="c1"># if this is the first iteration, initialize variables</span>
    <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">current_detector_idx</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># select first image</span>
        <span class="n">covfile</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">covfile</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># calculate the overlap with all the rest of the files</span>
        <span class="n">maxcoverage</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">best_overlap_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">detectors</span><span class="p">)):</span>
            <span class="n">detector</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">detector_coords</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="n">coverage</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">referencia</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>

            <span class="n">covfile</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">coverage</span> <span class="o">/</span> <span class="n">detector</span><span class="o">.</span><span class="n">area</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">covfile</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">maxcoverage</span><span class="p">:</span> 
                <span class="n">maxcoverage</span> <span class="o">=</span> <span class="n">covfile</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
                <span class="n">best_overlap_index</span> <span class="o">=</span> <span class="n">m</span>
                
        <span class="k">if</span> <span class="n">maxcoverage</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Some images are excluded'</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Number of excluded images: '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">detectors</span><span class="p">))</span>
            <span class="k">break</span>
            
        <span class="c1"># select the file with the maximum overlap</span>
        
        <span class="c1"># print overlap values</span>
        <span class="c1"># print(covfile)</span>
        <span class="c1"># print(best_overlap_index, covfile[best_overlap_index])</span>
        
        <span class="c1"># we set current index to the best overlap</span>
        <span class="n">current_detector_idx</span> <span class="o">=</span> <span class="n">best_overlap_index</span>

    <span class="c1"># remove the image from list and its coordinates</span>
    <span class="n">current_detector</span> <span class="o">=</span> <span class="n">detectors</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">current_detector_idx</span><span class="p">)</span>
    <span class="n">current_detector_coords</span> <span class="o">=</span> <span class="n">detector_coords</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">current_detector_idx</span><span class="p">)</span>
    
    <span class="n">referencia</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">current_detector_coords</span><span class="p">)</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">referencia</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">current_detector_coords</span><span class="p">))</span>
         
    <span class="nb">print</span><span class="p">(</span><span class="s1">'removing current detector '</span> <span class="o">+</span> <span class="n">current_detector</span><span class="p">)</span>
    <span class="n">finallist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_detector</span><span class="p">)</span>
    <span class="n">finalcoords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_detector_coords</span><span class="p">)</span>


    <span class="c1"># Plot </span>
    <span class="c1"># ----</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">'w'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'k'</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    
    <span class="n">rect1</span> <span class="o">=</span> <span class="n">leopolygon</span><span class="p">([</span>
        <span class="p">(</span><span class="mf">80.3125</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.4950</span><span class="p">),</span> 
        <span class="p">(</span><span class="mf">80.4958</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.4392</span><span class="p">),</span> 
        <span class="p">(</span><span class="mf">80.6625</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.5022</span><span class="p">),</span> 
        <span class="p">(</span><span class="mf">80.4792</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.5564</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'yellow'</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect1</span><span class="p">)</span>
    
    <span class="n">rect2</span> <span class="o">=</span> <span class="n">leopolygon</span><span class="p">(</span><span class="n">current_detector_coords</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">'navy'</span><span class="p">,</span> 
                       <span class="n">facecolor</span><span class="o">=</span><span class="s1">'navy'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">cascaded_union</span><span class="p">(</span><span class="n">referencia</span><span class="p">)</span>
    <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">new_shape</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">xy</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">'red'</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s1">'red'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect2</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mf">80.2</span><span class="p">,</span> <span class="mf">80.8</span><span class="p">])</span> <span class="c1"># RA</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">69.4</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.6</span><span class="p">])</span> <span class="c1"># Dec</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'coverage = </span><span class="si">{}</span><span class="s1">% </span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">covfile</span><span class="p">[</span><span class="n">current_detector_idx</span><span class="p">]),</span> 
                                            <span class="n">current_detector</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'RA (degrees)'</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Dec (degrees)'</span><span class="p">)</span>
    
    <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">'figure_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">finallist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># plt.savefig(pdfname) </span>
  
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
     
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">finallist</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <p>
             Here we need to go through the final list and calculate the overlap
with the stellar catalogue. We select the files that have an overlap of 99% or larger.
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">bestlist</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># these coordinates represent the extent of the LMC catalogue</span>
<span class="n">referencia</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="mf">80.3125</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.4950</span><span class="p">),</span> 
                      <span class="p">(</span><span class="mf">80.4958</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.4392</span><span class="p">),</span> 
                      <span class="p">(</span><span class="mf">80.6625</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.5022</span><span class="p">),</span> 
                      <span class="p">(</span><span class="mf">80.4792</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.5564</span><span class="p">)])</span>

<span class="n">rejected</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">current_detector</span><span class="p">,</span> <span class="n">current_detector_coords</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">finallist</span><span class="p">,</span> <span class="n">finalcoords</span><span class="p">):</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">current_detector_coords</span><span class="p">)</span>
    
    <span class="n">coverage</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">referencia</span><span class="p">)</span><span class="o">.</span><span class="n">area</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">coverage</span> <span class="o">/</span> <span class="n">detector</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">coverage</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span> <span class="c1">#99 </span>
        <span class="n">bestlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_detector</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rejected</span> <span class="o">+=</span> <span class="mi">1</span>
        
<span class="nb">print</span><span class="p">(</span><span class="s1">'number of overlapping images = '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bestlist</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'number of rejected images = '</span><span class="p">,</span> <span class="n">rejected</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="save-detector-list-to-an-association-json-file">
            <h3>
             Save Detector List to an Association (JSON file)
             <a class="headerlink" href="#save-detector-list-to-an-association-json-file" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             <em>
              Developer Note:
             </em>
            </p>
            <p>
             There is a new way to implement the association introduced in version 0.16.0 of the JWST package. It might be worthwhile to explore.
            </p>
            <p>
             The following link provides a complete description of the association keywords.
            </p>
            <p>
             <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/level3_asn_technical.html#association-meta-keywords">
              https://jwst-pipeline.readthedocs.io/en/latest/jwst/associations/level3_asn_technical.html#association-meta-keywords
             </a>
            </p>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># here we print a json file with the science files in the correct order</span>

<span class="n">association</span> <span class="o">=</span> <span class="p">{}</span>
 
<span class="n">association</span><span class="p">[</span><span class="s2">"asn_id"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a3001"</span>
<span class="n">association</span><span class="p">[</span><span class="s2">"asn_pool"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"none"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"asn_rule"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Asn_Image"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"program"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"1069"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"asn_type"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"image3"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"constraints"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"No constraints"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"target"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"none"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"version_id"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"null"</span> 
<span class="n">association</span><span class="p">[</span><span class="s2">"degraded_status"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"No known degraded exposures in association."</span>
    
<span class="n">products_dict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">products_dict</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"lmc-"</span> <span class="o">+</span> <span class="n">filtname</span> 
<span class="n">products_dict</span><span class="p">[</span><span class="s2">"members"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>   
<span class="k">for</span> <span class="n">current_detector</span> <span class="ow">in</span> <span class="n">bestlist</span><span class="p">:</span>
    <span class="n">obs_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"expname"</span><span class="p">:</span> <span class="n">current_detector</span><span class="p">,</span>
        <span class="s2">"exptype"</span><span class="p">:</span> <span class="s2">"science"</span>
    <span class="p">}</span>
    <span class="n">products_dict</span><span class="p">[</span><span class="s2">"members"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_dict</span><span class="p">)</span> 

<span class="n">association</span><span class="p">[</span><span class="s2">"products"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">products_dict</span><span class="p">]</span> 
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># save association file</span>
<span class="n">jsonfile</span> <span class="o">=</span> <span class="s2">"association-"</span> <span class="o">+</span> <span class="n">filtname</span> <span class="o">+</span> <span class="s2">".json"</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">association</span><span class="p">,</span> <span class="n">json_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
          </section>
         </section>
         <section class="tex2jax_ignore mathjax_ignore" id="execute-the-third-stage-of-the-nircam-pipeline">
          <h1>
           Execute the third stage of the NIRCam pipeline
           <a class="headerlink" href="#execute-the-third-stage-of-the-nircam-pipeline" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           Here we execute the third stage of the NIRCam pipeline. In this stage the pipeline creates a mosaic of the input images and extracts a source catalogue.
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="c1"># Execute pipeline</span>
<span class="c1"># ----------------</span>

<span class="c1"># run Image3 pipeline to get source catalog</span>
<span class="n">im3</span> <span class="o">=</span> <span class="n">Image3Pipeline</span><span class="p">()</span>

<span class="c1"># Options </span>
<span class="c1"># -------</span>

<span class="c1">#im3.source_catalog.kernel_fwhm = # kernel_fwhm</span>
<span class="c1">#im3.source_catalog.kernel_xsize = # kernel_xsize</span>
<span class="c1">#im3.source_catalog.kernel_ysize = # kernel_ysize</span>
<span class="c1">#im3.source_catalog.npixels = # npixels</span>
<span class="c1">#im3.tweakreg_catalog.snr_threshold = 2000.0</span>
<span class="c1">#im3.resample.blendheaders = False</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">enforce_user_order</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">fitgeometry</span> <span class="o">=</span> <span class="s1">'shift'</span> <span class="c1"># valid values are 'shift', 'rscale', 'general'</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">expand_refcat</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">minobj</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">use2dhist</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#im3.tweakreg.snr_threshold = 2000.0</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">save_catalogs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#im3.tweakreg.xoffset = 7.5</span>
<span class="c1">#im3.tweakreg.yoffset = -7.2</span>
<span class="n">im3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">searchrad</span> <span class="o">=</span> <span class="mf">0.1</span> 
<span class="n">im3</span><span class="o">.</span><span class="n">skymatch</span><span class="o">.</span><span class="n">skymethod</span> <span class="o">=</span> <span class="s1">'global'</span> <span class="c1"># valid values are: 'local', 'global', 'match', or 'global+match'</span>
<span class="n">im3</span><span class="o">.</span><span class="n">source_catalog</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span> 
<span class="n">im3</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="s1">'lmc-f150w-02.fits'</span>

<span class="c1"># Execute </span>
<span class="c1"># -------</span>

<span class="n">im3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
          </div>
          <section id="load-data-into-imviz">
           <h2>
            Load data into
            <a class="reference external" href="https://jdaviz.readthedocs.io/en/latest/imviz/index.html">
             Imviz
            </a>
            <a class="headerlink" href="#load-data-into-imviz" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">from</span> <span class="nn">jdaviz</span> <span class="kn">import</span> <span class="n">Imviz</span>
<span class="n">imviz</span> <span class="o">=</span> <span class="n">Imviz</span><span class="p">()</span>
<span class="n">imviz</span><span class="o">.</span><span class="n">show_in_sidecar</span><span class="p">()</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">imviz</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">'lmc-f150w-02_i2d.fits'</span><span class="p">)</span>
<span class="n">viewer</span> <span class="o">=</span> <span class="n">imviz</span><span class="o">.</span><span class="n">default_viewer</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">cuts</span> <span class="o">=</span> <span class="s1">'95%'</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">colormap_options</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">set_colormap</span><span class="p">(</span><span class="s1">'viridis'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "therealzoidberg/actions-ci-testing",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/preimaging"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
         <a class="left-prev" href="preimaging_01_mirage.html" id="prev-link" title="previous page">
          <i class="fas fa-angle-left">
          </i>
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            previous
           </p>
           <p class="prev-next-title">
            NIRCam Preimaging: MIRAGE Simulations
           </p>
          </div>
         </a>
         <a class="right-next" href="../ifu_optimal/ifu_optimal.html" id="next-link" title="next page">
          <div class="prev-next-info">
           <p class="prev-next-subtitle">
            next
           </p>
           <p class="prev-next-title">
            IFU Optimal Spectral Extraction
           </p>
          </div>
          <i class="fas fa-angle-right">
          </i>
         </a>
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        Â© Copyright 2022.
        <br/>
       </p>
       <div class="extra_footer">
        <div class="header">
         <div class="header content">
          <img alt="JWST Data Analysis Notebooks" class="logo" src="Jspectra.svg"/>
          <div class="search">
           <div class="searchbox">
           </div>
           <div class="searchbutton">
            Filter Notebooks
           </div>
          </div>
         </div>
        </div>
       </div>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>