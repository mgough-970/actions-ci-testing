<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>
  <title>
   Measuring Galaxy Redshifts with Cross-correlation — STScI JDAT Notebooks
  </title>
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
  <link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
  <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
  <link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/main.css" rel="stylesheet" type="text/css"/>
  <link href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>
  <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js">
  </script>
  <script src="../../_static/jquery.js">
  </script>
  <script src="../../_static/underscore.js">
  </script>
  <script src="../../_static/doctools.js">
  </script>
  <script src="../../_static/clipboard.min.js">
  </script>
  <script src="../../_static/copybutton.js">
  </script>
  <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411">
  </script>
  <script>
   let toggleHintShow = 'Click to show';
  </script>
  <script>
   let toggleHintHide = 'Click to hide';
  </script>
  <script>
   let toggleOpenOnPrint = 'true';
  </script>
  <script src="../../_static/togglebutton.js">
  </script>
  <script>
   var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';
  </script>
  <script src="../../_static/design-tabs.js">
  </script>
  <script>
   const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
  </script>
  <script async="async" src="../../_static/sphinx-thebe.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js">
  </script>
  <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js">
  </script>
  <link href="../../genindex.html" rel="index" title="Index"/>
  <link href="../../search.html" rel="search" title="Search"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="None" name="docsearch:language"/>
  <!-- Google Analytics -->
  <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-D46G4HKJY3">
  </script>
  <script>
   window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-D46G4HKJY3');
  </script>
 </head>
 <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
  <!-- Checkboxes to toggle the left sidebar -->
  <input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
  <label class="overlay overlay-navbar" for="__navigation">
   <div class="visually-hidden">
    Toggle navigation sidebar
   </div>
  </label>
  <!-- Checkboxes to toggle the in-page toc -->
  <input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
  <label class="overlay overlay-pagetoc" for="__page-toc">
   <div class="visually-hidden">
    Toggle in-page Table of Contents
   </div>
  </label>
  <!-- Headers at the top -->
  <div class="announcement header-item noprint">
  </div>
  <div class="header header-item noprint">
  </div>
  <div class="container-fluid" id="banner">
  </div>
  <div class="container-xl">
   <div class="row">
    <!-- Sidebar -->
    <div class="bd-sidebar noprint" id="site-navigation">
     <div class="bd-sidebar__content">
      <div class="bd-sidebar__top">
       <div class="navbar-brand-box">
        <a class="navbar-brand text-wrap" href="../../index.html">
         <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
         <img alt="logo" class="logo" src="../../_static/stsci_logo2.png"/>
         <h1 class="site-logo" id="site-title">
          STScI JDAT Notebooks
         </h1>
        </a>
       </div>
       <form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
        <i class="icon fas fa-search">
        </i>
        <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
       </form>
       <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
        <div class="bd-toc-item active">
         <ul class="nav bd-sidenav bd-sidenav__home-link">
          <li class="toctree-l1">
           <a class="reference internal" href="../../intro.html">
            James Webb Space Telescope Data Analysis Tool Notebooks
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MOS Spectroscopy
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../mos-spectroscopy/MOSspec_sv06_revised.html">
            MOS Spectroscopy of Extragalactic Field
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Example Notebook
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../example_notebook/example_notebook.html">
            Draft: Notebook title
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           IFU Continuum Fit
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../IFU_cube_continuum_fit/NGC4151_FeII_ContinuumFit.html">
            IFU Cube Fitting
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           PSF Matched Photometry
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRCam_PSF-matched_photometry/NIRCam_PSF_matched_multiband_photometry.html">
            Cross-Filter PSF Matching
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI IFU in the LMC
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_IFU_YSOs_in_the_LMC/isha_nayak_ysos_in_the_lmc.html">
            IFU of YSOs in LMC
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Preimaging
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../preimaging/preimaging_02_calwebb.html">
            NIRCam Preimaging: Pipeline Stages 1, 2
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../preimaging/preimaging_01_mirage.html">
            NIRCam Preimaging: MIRAGE Simulations
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../preimaging/preimaging_03_association.html">
            NIRCam Preimaging: Pipeline Stage 3
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Optimal Extraction
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../ifu_optimal/ifu_optimal.html">
            IFU Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           SOSS Transient Spectroscopy
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../soss-transit-spectroscopy/HAT-P-1b-PART3-data-analysis.html">
            SOSS Transit Spectroscopy
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           PSF Photometry
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../psf_photometry/NIRCam_PSF_Photometry_Example.html">
            PSF Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Specviz Interaction
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../specviz_notebookGUI_interaction/specviz_notebook_gui_interaction_redshift.html">
            Specviz Simple Demo
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           ASDF Example
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../asdf_example/asdf_example.html">
            ASDF Example
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Composite Model Fitting
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../composite_model_fitting/specfit_demo_3.html">
            Composite Model Spectral Fitting
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRISS AMI Binary
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../niriss_ami_binary/1_niriss_ami_binary.html">
            NIRISS AMI: MIRAGE Simulations
           </a>
          </li>
          <li class="toctree-l1">
           <a class="reference internal" href="../niriss_ami_binary/2_niriss_ami_binary.html">
            NIRISS AMI: Pipeline
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Aperture Photometry
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../aperture_photometry/NIRCam_Aperture_Photometry_Example.html">
            Point Source Aperture Photometry
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           NIRSpec MAST Query
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../NIRSpec_MAST_Query/NIRSpec_MAST_Query.html">
            MAST Query
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           MIRI LRS Extraction
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../MIRI_LRS_spectral_extraction/miri_lrs_spectral_extraction.html">
            LRS Optimal Spectral Extraction
           </a>
          </li>
         </ul>
         <p aria-level="2" class="caption" role="heading">
          <span class="caption-text">
           Transient Spectroscopy
          </span>
         </p>
         <ul class="nav bd-sidenav">
          <li class="toctree-l1">
           <a class="reference internal" href="../transit_spectroscopy_notebook/Exoplanet_Transmission_Spectra_JWST.html">
            BOTS Time Series Observations
           </a>
          </li>
         </ul>
        </div>
       </nav>
      </div>
      <div class="bd-sidebar__bottom">
       <!-- To handle the deprecated key -->
       <div class="navbar_extra_footer">
        Powered by
        <a href="https://jupyterbook.org">
         Jupyter Book
        </a>
       </div>
      </div>
     </div>
     <div id="rtd-footer-container">
     </div>
    </div>
    <!-- A tiny helper pixel to detect if we've scrolled -->
    <div class="sbt-scroll-pixel-helper">
    </div>
    <!-- Main content -->
    <div class="col py-0 content-container">
     <div class="header-article row sticky-top noprint">
      <div class="col py-1 d-flex header-article-main">
       <div class="header-article__left">
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
         <span class="headerbtn__icon-container">
          <i class="fas fa-bars">
          </i>
         </span>
        </label>
       </div>
       <div class="header-article__right">
        <div class="menu-dropdown menu-dropdown-launch-buttons">
         <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-rocket">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://mybinder.org/v2/gh/therealzoidberg/actions-ci-testing/main?urlpath=tree/notebooks/notebooks/redshift_crosscorr/redshift_with_crosscorr.ipynb" title="Launch on Binder">
             <span class="headerbtn__icon-container">
              <img src="../../_static/images/logo_binder.svg"/>
             </span>
             <span class="headerbtn__text-container">
              Binder
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn headerbtn-launch-thebe" data-placement="left" data-toggle="tooltip" onclick="initThebeSBT()" title="Launch Thebe">
             <span class="headerbtn__icon-container">
              <i class="fas fa-play">
              </i>
             </span>
             <span class="headerbtn__text-container">
              Live Code
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
         <span class="headerbtn__icon-container">
          <i class="fas fa-expand">
          </i>
         </span>
        </button>
        <div class="menu-dropdown menu-dropdown-repository-buttons">
         <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
          <i class="fab fa-github">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/therealzoidberg/actions-ci-testing/" title="Source repository">
             <span class="headerbtn__icon-container">
              <i class="fab fa-github">
              </i>
             </span>
             <span class="headerbtn__text-container">
              repository
             </span>
            </a>
           </li>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/therealzoidberg/actions-ci-testing//issues/new?title=Issue%20on%20page%20%2Fnotebooks/redshift_crosscorr/redshift_with_crosscorr.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
             <span class="headerbtn__icon-container">
              <i class="fas fa-lightbulb">
              </i>
             </span>
             <span class="headerbtn__text-container">
              open issue
             </span>
            </a>
           </li>
          </ul>
         </div>
        </div>
        <div class="menu-dropdown menu-dropdown-download-buttons">
         <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
          <i class="fas fa-download">
          </i>
         </button>
         <div class="menu-dropdown__content">
          <ul>
           <li>
            <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="../../_sources/notebooks/redshift_crosscorr/redshift_with_crosscorr.ipynb" title="Download source file">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .ipynb
             </span>
            </a>
           </li>
           <li>
            <button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
             <span class="headerbtn__icon-container">
              <i class="fas fa-file-pdf">
              </i>
             </span>
             <span class="headerbtn__text-container">
              .pdf
             </span>
            </button>
           </li>
          </ul>
         </div>
        </div>
        <label class="headerbtn headerbtn-page-toc" for="__page-toc">
         <span class="headerbtn__icon-container">
          <i class="fas fa-list">
          </i>
         </span>
        </label>
       </div>
      </div>
      <!-- Table of contents -->
      <div class="col-md-3 bd-toc show noprint">
       <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list">
        </i>
        Contents
       </div>
       <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
           Matplotlib setup for plotting
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#define-data-files">
             Define data files:
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#read-observation-and-template">
             Read observation and template:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#preprocess-spectra">
           Preprocess Spectra
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#subtract-continuum">
             Subtract continuum
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#smooth-observed-spectrum">
             Smooth observed spectrum
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#cross-correlate">
           Cross correlate
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#fit-correlation-peak">
           Fit correlation peak
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#visual-check">
           Visual check
          </a>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#case-with-lower-resolution-observed-spectrum">
           Case with lower resolution observed spectrum
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id1">
             Read observation and template:
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#id2">
           Preprocess Spectra
          </a>
          <ul class="nav section-nav flex-column">
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id3">
             Subtract continuum
            </a>
           </li>
           <li class="toc-h3 nav-item toc-entry">
            <a class="reference internal nav-link" href="#id4">
             Smooth observed spectrum
            </a>
           </li>
          </ul>
         </li>
         <li class="toc-h2 nav-item toc-entry">
          <a class="reference internal nav-link" href="#id5">
           Cross correlate
          </a>
         </li>
        </ul>
       </nav>
      </div>
     </div>
     <div class="article row">
      <div class="col pl-md-3 pl-lg-5 content-container">
       <!-- Table of contents that is only displayed when printing the page -->
       <div class="onlyprint" id="jb-print-docs-body">
        <h1>
         Measuring Galaxy Redshifts with Cross-correlation
        </h1>
        <!-- Table of contents -->
        <div id="print-main-content">
         <div id="jb-print-toc">
          <div>
           <h2>
            Contents
           </h2>
          </div>
          <nav aria-label="Page">
           <ul class="visible nav section-nav flex-column">
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#matplotlib-setup-for-plotting">
              Matplotlib setup for plotting
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#define-data-files">
                Define data files:
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#read-observation-and-template">
                Read observation and template:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#preprocess-spectra">
              Preprocess Spectra
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#subtract-continuum">
                Subtract continuum
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#smooth-observed-spectrum">
                Smooth observed spectrum
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#cross-correlate">
              Cross correlate
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#fit-correlation-peak">
              Fit correlation peak
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#visual-check">
              Visual check
             </a>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#case-with-lower-resolution-observed-spectrum">
              Case with lower resolution observed spectrum
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id1">
                Read observation and template:
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#id2">
              Preprocess Spectra
             </a>
             <ul class="nav section-nav flex-column">
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id3">
                Subtract continuum
               </a>
              </li>
              <li class="toc-h3 nav-item toc-entry">
               <a class="reference internal nav-link" href="#id4">
                Smooth observed spectrum
               </a>
              </li>
             </ul>
            </li>
            <li class="toc-h2 nav-item toc-entry">
             <a class="reference internal nav-link" href="#id5">
              Cross correlate
             </a>
            </li>
           </ul>
          </nav>
         </div>
        </div>
       </div>
       <main id="main-content" role="main">
        <div>
         <section class="tex2jax_ignore mathjax_ignore" id="measuring-galaxy-redshifts-with-cross-correlation">
          <h1>
           Measuring Galaxy Redshifts with Cross-correlation
           <a class="headerlink" href="#measuring-galaxy-redshifts-with-cross-correlation" title="Permalink to this headline">
            #
           </a>
          </h1>
          <p>
           This notebook attempts to follow the workflow that uses IRAF tasks, described here
           <a class="reference external" href="http://tdc-www.harvard.edu/iraf/rvsao/xcsao/xcsao.proc.html">
            http://tdc-www.harvard.edu/iraf/rvsao/xcsao/xcsao.proc.html
           </a>
          </p>
          <p>
           Observed spectrum from LEGA-C: LEGA-C is a galaxy survey of about 3000 galaxies at z~0.8 and M* &gt; 10^10 M_sun in the COSMOS field. The spectra sample the rest-frame optical between ~3000A and 5000A at high resolution and very high signal-to-noise ratio. More information about the survey can be found here:
           <a class="reference external" href="http://www.mpia.de/home/legac/">
            http://www.mpia.de/home/legac/
           </a>
          </p>
          <p>
           Template from Pacifici et al. 2012.
          </p>
          <p>
           <strong>
            Developer Notes:
           </strong>
           - This workflow will be rendered in a few simple clicks in specviz
- Preparing the template outside the correlation function allows for applications to different science cases
          </p>
          <p>
           Author: Ivo Busko
          </p>
          <div class="cell docutils container">
           <div class="cell_input docutils container">
            <div class="highlight-ipython3 notranslate">
             <div class="highlight">
              <pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy.signal.windows</span> <span class="kn">import</span> <span class="n">tukey</span>
<span class="kn">import</span> <span class="nn">astropy</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">QTable</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="kn">import</span> <span class="n">StdDevUncertainty</span>
<span class="kn">from</span> <span class="nn">astropy.modeling.polynomial</span> <span class="kn">import</span> <span class="n">Chebyshev1D</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span><span class="p">,</span> <span class="n">ascii</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>

<span class="kn">import</span> <span class="nn">specutils</span>
<span class="kn">from</span> <span class="nn">specutils.fitting</span> <span class="kn">import</span> <span class="n">continuum</span><span class="p">,</span> <span class="n">find_lines_threshold</span><span class="p">,</span> <span class="n">find_lines_derivative</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">Spectrum1D</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">FluxConservingResampler</span><span class="p">,</span> <span class="n">SplineInterpolatedResampler</span><span class="p">,</span> <span class="n">LinearInterpolatedResampler</span>
<span class="kn">from</span> <span class="nn">specutils.analysis</span> <span class="kn">import</span> <span class="n">correlation</span>
<span class="kn">from</span> <span class="nn">specutils</span> <span class="kn">import</span> <span class="n">SpectralRegion</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">extract_region</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">linear_exciser</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">noise_region_uncertainty</span>
<span class="kn">from</span> <span class="nn">specutils.manipulation</span> <span class="kn">import</span> <span class="n">gaussian_smooth</span><span class="p">,</span> <span class="n">convolution_smooth</span>

<span class="c1"># Check versions</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Numpy: "</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Astropy: "</span><span class="p">,</span><span class="n">astropy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Specutils: "</span><span class="p">,</span><span class="n">specutils</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"They should be:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Numpy:  1.18.1"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Astropy:  4.0"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Specutils:  1.0"</span><span class="p">)</span>
</pre>
             </div>
            </div>
           </div>
           <div class="cell_output docutils container">
            <div class="output stream highlight-myst-ansi notranslate">
             <div class="highlight">
              <pre><span></span>Numpy:  1.23.2
Astropy:  5.1
Specutils:  1.7.0

They should be:
Numpy:  1.18.1
Astropy:  4.0
Specutils:  1.0
</pre>
             </div>
            </div>
           </div>
          </div>
          <section id="matplotlib-setup-for-plotting">
           <h2>
            Matplotlib setup for plotting
            <a class="headerlink" href="#matplotlib-setup-for-plotting" title="Permalink to this headline">
             #
            </a>
           </h2>
           <p>
            There are two versions
           </p>
           <ul class="simple">
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                notebook
               </span>
              </code>
              – gives interactive plots, but makes the overall notebook a bit harder to scroll
             </p>
            </li>
            <li>
             <p>
              <code class="docutils literal notranslate">
               <span class="pre">
                inline
               </span>
              </code>
              – gives non-interactive plots for better overall scrolling
             </p>
            </li>
           </ul>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Use this version for non-interactive plots (easier scrolling of the notebook)</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># Use this version if you want interactive plots</span>
<span class="c1"># %matplotlib notebook</span>

<span class="c1"># These gymnastics are needed to make the sizes of the figures</span>
<span class="c1"># be the same in both the inline and notebook versions</span>
<span class="o">%</span><span class="k">config</span> InlineBackend.print_figure_kwargs = {'bbox_inches': None}

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'savefig.dpi'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.dpi'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">80</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <section id="define-data-files">
            <h3>
             Define data files:
             <a class="headerlink" href="#define-data-files" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Files are on box</span>

<span class="c1"># Observation and weight.</span>
<span class="n">file1d</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/legac_M1_v3.7_spec1d_130902.fits'</span>
<span class="n">file1dwht</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/legac_M1_v3.7_wht1d_130902.fits'</span>
<span class="c1"># Template.</span>
<span class="n">template_file</span> <span class="o">=</span> <span class="s1">'https://data.science.stsci.edu/redirect/JWST/jwst-data_analysis_tools/redshift_crosscorr/00006.dat'</span>

<span class="c1"># Plot limits</span>
<span class="n">sp_xlim</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3000.</span><span class="p">,</span> <span class="mf">9000.</span><span class="p">]</span>
</pre>
               </div>
              </div>
             </div>
            </div>
           </section>
           <section id="read-observation-and-template">
            <h3>
             Read observation and template:
             <a class="headerlink" href="#read-observation-and-template" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Observation</span>
<span class="n">hdu1d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1d</span><span class="p">)</span>
<span class="n">hdu1dwht</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1dwht</span><span class="p">)</span>

<span class="n">flux</span> <span class="o">=</span> <span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wht</span> <span class="o">=</span> <span class="n">hdu1dwht</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">unc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wht</span><span class="p">)</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">'10^-19 erg s^-1 cm^-2 angstrom^-1'</span><span class="p">)</span>
<span class="n">dataspec</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span> <span class="n">flux</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">,</span> <span class="n">wht</span><span class="p">,</span> <span class="n">unc</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">],</span> 
                   <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">'wavelength'</span><span class="p">,</span><span class="s1">'flux'</span><span class="p">,</span><span class="s1">'weight'</span><span class="p">,</span><span class="s1">'uncertainty'</span><span class="p">))</span>
<span class="n">dataspec_sub</span> <span class="o">=</span> <span class="n">dataspec</span><span class="p">[</span><span class="n">dataspec</span><span class="p">[</span><span class="s1">'weight'</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">]</span>
<span class="n">dataspec_sub</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_3444/3474148523.py:7: RuntimeWarning: divide by zero encountered in divide
  unc = 1./ np.sqrt(wht)
WARNING: FITSFixedWarning: RADECSYS= 'FK5 ' / Coordinate reference frame 
the RADECSYS keyword is deprecated, use RADESYSa. [astropy.wcs.wcs]
WARNING: FITSFixedWarning: The WCS transformation has more axes (2) than the image it is associated with (1) [astropy.wcs.wcs]
</pre>
               </div>
              </div>
              <div class="output text_html">
               <div>
                <i>
                 QTable length=4059
                </i>
                <table class="table-striped table-bordered table-condensed" id="table140604238059168">
                 <thead>
                  <tr>
                   <th>
                    wavelength
                   </th>
                   <th>
                    flux
                   </th>
                   <th>
                    weight
                   </th>
                   <th>
                    uncertainty
                   </th>
                  </tr>
                 </thead>
                 <thead>
                  <tr>
                   <th>
                    Angstrom
                   </th>
                   <th>
                    1e-19 erg / (Angstrom cm2 s)
                   </th>
                   <th>
                   </th>
                   <th>
                    1e-19 erg / (Angstrom cm2 s)
                   </th>
                  </tr>
                 </thead>
                 <thead>
                  <tr>
                   <th>
                    float64
                   </th>
                   <th>
                    float32
                   </th>
                   <th>
                    float32
                   </th>
                   <th>
                    float32
                   </th>
                  </tr>
                 </thead>
                 <tr>
                  <td>
                   6229.3
                  </td>
                  <td>
                   14.757168769836426
                  </td>
                  <td>
                   0.20703126
                  </td>
                  <td>
                   2.1977689266204834
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6229.900000000001
                  </td>
                  <td>
                   26.817886352539062
                  </td>
                  <td>
                   0.14812198
                  </td>
                  <td>
                   2.5983057022094727
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6230.5
                  </td>
                  <td>
                   23.95525360107422
                  </td>
                  <td>
                   0.14219064
                  </td>
                  <td>
                   2.651945114135742
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6231.1
                  </td>
                  <td>
                   22.23990249633789
                  </td>
                  <td>
                   0.14140277
                  </td>
                  <td>
                   2.659322738647461
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6231.7
                  </td>
                  <td>
                   22.505369186401367
                  </td>
                  <td>
                   0.13691239
                  </td>
                  <td>
                   2.702580213546753
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6232.3
                  </td>
                  <td>
                   21.266435623168945
                  </td>
                  <td>
                   0.12861502
                  </td>
                  <td>
                   2.788393974304199
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6232.900000000001
                  </td>
                  <td>
                   21.235198974609375
                  </td>
                  <td>
                   0.11325585
                  </td>
                  <td>
                   2.9714584350585938
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6233.5
                  </td>
                  <td>
                   24.18277359008789
                  </td>
                  <td>
                   0.096821204
                  </td>
                  <td>
                   3.2137696743011475
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6234.1
                  </td>
                  <td>
                   32.75020980834961
                  </td>
                  <td>
                   0.085573986
                  </td>
                  <td>
                   3.4184489250183105
                  </td>
                 </tr>
                 <tr>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8677.9
                  </td>
                  <td>
                   46.554779052734375
                  </td>
                  <td>
                   0.08704492
                  </td>
                  <td>
                   3.3894426822662354
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8678.5
                  </td>
                  <td>
                   45.3433837890625
                  </td>
                  <td>
                   0.08504387
                  </td>
                  <td>
                   3.429086923599243
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8679.1
                  </td>
                  <td>
                   46.19153594970703
                  </td>
                  <td>
                   0.06836141
                  </td>
                  <td>
                   3.824674606323242
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8679.7
                  </td>
                  <td>
                   49.632057189941406
                  </td>
                  <td>
                   0.058549482
                  </td>
                  <td>
                   4.132743835449219
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8680.3
                  </td>
                  <td>
                   40.599159240722656
                  </td>
                  <td>
                   0.04911178
                  </td>
                  <td>
                   4.51239538192749
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8680.9
                  </td>
                  <td>
                   46.05984115600586
                  </td>
                  <td>
                   0.0454888
                  </td>
                  <td>
                   4.6886491775512695
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8681.5
                  </td>
                  <td>
                   53.85580825805664
                  </td>
                  <td>
                   0.049859755
                  </td>
                  <td>
                   4.478421211242676
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8682.1
                  </td>
                  <td>
                   51.271400451660156
                  </td>
                  <td>
                   0.058481682
                  </td>
                  <td>
                   4.135138511657715
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8682.7
                  </td>
                  <td>
                   51.61949920654297
                  </td>
                  <td>
                   0.069049306
                  </td>
                  <td>
                   3.805575370788574
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8683.3
                  </td>
                  <td>
                   51.20613098144531
                  </td>
                  <td>
                   0.08998948
                  </td>
                  <td>
                   3.3335282802581787
                  </td>
                 </tr>
                </table>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Now make it into a Spectrum1D instance.</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">'wavelength'</span><span class="p">],</span> 
                 <span class="n">flux</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">'flux'</span><span class="p">],</span> 
                 <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">'uncertainty'</span><span class="p">]))</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">2.E-5</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># normalize template to a sensible range</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">'col1'</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> 
                      <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">'col2'</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Note that in this and in subsequent plots, we are showing just the wavelength range of</span>
<span class="c1"># interest. The template covers a significantly wider range.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Input data'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Input data')
</pre>
               </div>
              </div>
              <img alt="../../_images/redshift_with_crosscorr_10_1.png" src="../../_images/redshift_with_crosscorr_10_1.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="preprocess-spectra">
           <h2>
            Preprocess Spectra
            <a class="headerlink" href="#preprocess-spectra" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="subtract-continuum">
            <h3>
             Subtract continuum
             <a class="headerlink" href="#subtract-continuum" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> 
<span class="n">p_obs</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
<span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> 
<span class="n">p_template</span> <span class="o">=</span> <span class="n">template</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>WARNING: Model is linear in parameters; consider using linear fitting methods. [astropy.modeling.fitting]
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'After continuum subtraction'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'After continuum subtraction')
</pre>
               </div>
              </div>
              <img alt="../../_images/redshift_with_crosscorr_14_1.png" src="../../_images/redshift_with_crosscorr_14_1.png"/>
             </div>
            </div>
           </section>
           <section id="smooth-observed-spectrum">
            <h3>
             Smooth observed spectrum
             <a class="headerlink" href="#smooth-observed-spectrum" title="Permalink to this headline">
              #
             </a>
            </h3>
            <p>
             The IRAF task XCORR works in Fourier space. In there, it applies a cosine bell filter (raised-cosine filter) to the observed spectrum, before multiplying together the two Fourier transforms. Here, we are working in data space, thus we emulate the filter operation by convolving the observed spectrum with a windowed sinc smoothing function.
            </p>
            <p>
             <strong>
              Developer Notes:
             </strong>
            </p>
            <ul class="simple">
             <li>
              <p>
               We should implement this window function in specutils so the user doe
sn’t have to:
               <a class="reference external" href="https://github.com/astropy/specutils/issues/636">
                https://github.com/astropy/specutils/issues/636
               </a>
              </p>
             </li>
             <li>
              <p>
               We should implement a fourier-space version of the xcorr as well as t
he current freq/wave-space version
              </p>
             </li>
            </ul>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Smooth data with sinc kernel</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># Cutoff frequency as a fraction of the sampling rate (in (0, 0.5)).</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.49</span>   <span class="c1"># Transition band, as a fraction of the sampling rate (in (0, 0.5)).</span>

<span class="c1"># The IRAF task uses the above values. Here, we try</span>
<span class="c1"># a much lower cutoff frequency to really dampen the</span>
<span class="c1"># high frequency structure in the observed spectrum.</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.05</span> 

<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">4</span> <span class="o">/</span> <span class="n">b</span><span class="p">)))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># N must be odd</span>
    <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
 
<span class="c1"># Compute sinc filter and Blackman window. Multiply filter </span>
<span class="c1"># by window and normalize to get unity gain.</span>
<span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">w</span> <span class="o">=</span> <span class="mf">0.42</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
    <span class="mf">0.08</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">filt</span> <span class="o">*=</span> <span class="n">w</span>
<span class="n">filt</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>

<span class="c1"># Smooth</span>
<span class="n">p_obs_smoothed</span> <span class="o">=</span> <span class="n">convolution_smooth</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'After smoothing'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'After smoothing')
</pre>
               </div>
              </div>
              <img alt="../../_images/redshift_with_crosscorr_19_1.png" src="../../_images/redshift_with_crosscorr_19_1.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="cross-correlate">
           <h2>
            Cross correlate
            <a class="headerlink" href="#cross-correlate" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Correlation. </span>
<span class="c1">#</span>
<span class="c1"># With no additional specifications, both the entire template and entire spectrum </span>
<span class="c1"># will be included in the correlation computation. This in general will incur in </span>
<span class="c1"># a significant increase in execution time. It is advised that the template is cut</span>
<span class="c1"># to work only on the useful region.</span>

<span class="n">corr</span><span class="p">,</span> <span class="n">lag</span> <span class="o">=</span> <span class="n">correlation</span><span class="o">.</span><span class="n">template_correlate</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="p">,</span> <span class="n">p_template</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">300000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Text(0.5, 0, 'km / s')
</pre>
              </div>
             </div>
             <img alt="../../_images/redshift_with_crosscorr_22_1.png" src="../../_images/redshift_with_crosscorr_22_1.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Redshift based on maximum</span>
<span class="n">index_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">corr</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">'km/s'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Peak maximum at: "</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Redshift from peak maximum: "</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Peak maximum at:  227330.87493846833 km / s
Redshift from peak maximum:  0.7582941760945445
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="fit-correlation-peak">
           <h2>
            Fit correlation peak
            <a class="headerlink" href="#fit-correlation-peak" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Redshift based on parabolic fit to mazimum</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># points to the left or right of correlation maximum</span>

<span class="n">peak_lags</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">peak_vals</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">v_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="c1"># maximum lies at mid point between roots</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v_fit</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">'km/s'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Parabolic fit with maximum at: "</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Redshift from parabolic fit: "</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Parabolic fit with maximum at:  227331.80765331045 km / s
Redshift from parabolic fit:  0.7582972872963684
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="visual-check">
           <h2>
            Visual check
            <a class="headerlink" href="#visual-check" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="c1"># plt.xlim(sp_xlim)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'data'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">peak_lags</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'fit'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Fit to correlation peak'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Text(0.5, 1.0, 'Fit to correlation peak')
</pre>
              </div>
             </div>
             <img alt="../../_images/redshift_with_crosscorr_27_1.png" src="../../_images/redshift_with_crosscorr_27_1.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">z_ref</span> <span class="o">=</span> <span class="mf">0.758</span> <span class="c1"># "true" redshift, corresponding to 227242.6 km/s</span>

<span class="n">template_z</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">),</span> <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template_z</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template_z</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Redshifted original template and original observed spectrum'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Text(0.5, 1.0, 'Redshifted original template and original observed spectrum')
</pre>
              </div>
             </div>
             <img alt="../../_images/redshift_with_crosscorr_29_1.png" src="../../_images/redshift_with_crosscorr_29_1.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">z_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_ref</span><span class="p">)</span> <span class="o">/</span> <span class="n">z_ref</span> <span class="o">*</span> <span class="mf">100.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Error in the derived redshift: "</span><span class="p">,</span> <span class="n">z_err</span><span class="p">,</span> <span class="s2">"%"</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Error in the derived redshift:  0.039219959943054584 %
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
          <section id="case-with-lower-resolution-observed-spectrum">
           <h2>
            Case with lower resolution observed spectrum
            <a class="headerlink" href="#case-with-lower-resolution-observed-spectrum" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id1">
            <h3>
             Read observation and template:
             <a class="headerlink" href="#id1" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Observation</span>
<span class="n">hdu1d</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1d</span><span class="p">)</span>
<span class="n">hdu1dwht</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file1dwht</span><span class="p">)</span>

<span class="n">flux</span> <span class="o">=</span> <span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">wht</span> <span class="o">=</span> <span class="n">hdu1dwht</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">unc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wht</span><span class="p">)</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'CD1_1'</span><span class="p">]</span> <span class="o">+</span> <span class="n">hdu1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">'CRVAL1'</span><span class="p">]</span>

<span class="n">spec_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s1">'10^-19 erg s^-1 cm^-2 angstrom^-1'</span><span class="p">)</span>
<span class="n">dataspec</span> <span class="o">=</span> <span class="n">QTable</span><span class="p">([</span><span class="n">wave</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="p">,</span> <span class="n">flux</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">,</span> <span class="n">wht</span><span class="p">,</span> <span class="n">unc</span><span class="o">*</span><span class="n">spec_unit</span><span class="p">],</span> 
                   <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">'wavelength'</span><span class="p">,</span><span class="s1">'flux'</span><span class="p">,</span><span class="s1">'weight'</span><span class="p">,</span><span class="s1">'uncertainty'</span><span class="p">))</span>
<span class="n">dataspec_sub</span> <span class="o">=</span> <span class="n">dataspec</span><span class="p">[</span><span class="n">dataspec</span><span class="p">[</span><span class="s1">'weight'</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">]</span>
<span class="n">dataspec_sub</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output stderr highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>/tmp/ipykernel_3444/1377199938.py:7: RuntimeWarning: divide by zero encountered in divide
  unc = 1./ np.sqrt(wht)
</pre>
               </div>
              </div>
              <div class="output text_html">
               <div>
                <i>
                 QTable length=4059
                </i>
                <table class="table-striped table-bordered table-condensed" id="table140604228228048">
                 <thead>
                  <tr>
                   <th>
                    wavelength
                   </th>
                   <th>
                    flux
                   </th>
                   <th>
                    weight
                   </th>
                   <th>
                    uncertainty
                   </th>
                  </tr>
                 </thead>
                 <thead>
                  <tr>
                   <th>
                    Angstrom
                   </th>
                   <th>
                    1e-19 erg / (Angstrom cm2 s)
                   </th>
                   <th>
                   </th>
                   <th>
                    1e-19 erg / (Angstrom cm2 s)
                   </th>
                  </tr>
                 </thead>
                 <thead>
                  <tr>
                   <th>
                    float64
                   </th>
                   <th>
                    float32
                   </th>
                   <th>
                    float32
                   </th>
                   <th>
                    float32
                   </th>
                  </tr>
                 </thead>
                 <tr>
                  <td>
                   6229.3
                  </td>
                  <td>
                   14.757168769836426
                  </td>
                  <td>
                   0.20703126
                  </td>
                  <td>
                   2.1977689266204834
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6229.900000000001
                  </td>
                  <td>
                   26.817886352539062
                  </td>
                  <td>
                   0.14812198
                  </td>
                  <td>
                   2.5983057022094727
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6230.5
                  </td>
                  <td>
                   23.95525360107422
                  </td>
                  <td>
                   0.14219064
                  </td>
                  <td>
                   2.651945114135742
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6231.1
                  </td>
                  <td>
                   22.23990249633789
                  </td>
                  <td>
                   0.14140277
                  </td>
                  <td>
                   2.659322738647461
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6231.7
                  </td>
                  <td>
                   22.505369186401367
                  </td>
                  <td>
                   0.13691239
                  </td>
                  <td>
                   2.702580213546753
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6232.3
                  </td>
                  <td>
                   21.266435623168945
                  </td>
                  <td>
                   0.12861502
                  </td>
                  <td>
                   2.788393974304199
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6232.900000000001
                  </td>
                  <td>
                   21.235198974609375
                  </td>
                  <td>
                   0.11325585
                  </td>
                  <td>
                   2.9714584350585938
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6233.5
                  </td>
                  <td>
                   24.18277359008789
                  </td>
                  <td>
                   0.096821204
                  </td>
                  <td>
                   3.2137696743011475
                  </td>
                 </tr>
                 <tr>
                  <td>
                   6234.1
                  </td>
                  <td>
                   32.75020980834961
                  </td>
                  <td>
                   0.085573986
                  </td>
                  <td>
                   3.4184489250183105
                  </td>
                 </tr>
                 <tr>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                  <td>
                   ...
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8677.9
                  </td>
                  <td>
                   46.554779052734375
                  </td>
                  <td>
                   0.08704492
                  </td>
                  <td>
                   3.3894426822662354
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8678.5
                  </td>
                  <td>
                   45.3433837890625
                  </td>
                  <td>
                   0.08504387
                  </td>
                  <td>
                   3.429086923599243
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8679.1
                  </td>
                  <td>
                   46.19153594970703
                  </td>
                  <td>
                   0.06836141
                  </td>
                  <td>
                   3.824674606323242
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8679.7
                  </td>
                  <td>
                   49.632057189941406
                  </td>
                  <td>
                   0.058549482
                  </td>
                  <td>
                   4.132743835449219
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8680.3
                  </td>
                  <td>
                   40.599159240722656
                  </td>
                  <td>
                   0.04911178
                  </td>
                  <td>
                   4.51239538192749
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8680.9
                  </td>
                  <td>
                   46.05984115600586
                  </td>
                  <td>
                   0.0454888
                  </td>
                  <td>
                   4.6886491775512695
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8681.5
                  </td>
                  <td>
                   53.85580825805664
                  </td>
                  <td>
                   0.049859755
                  </td>
                  <td>
                   4.478421211242676
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8682.1
                  </td>
                  <td>
                   51.271400451660156
                  </td>
                  <td>
                   0.058481682
                  </td>
                  <td>
                   4.135138511657715
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8682.7
                  </td>
                  <td>
                   51.61949920654297
                  </td>
                  <td>
                   0.069049306
                  </td>
                  <td>
                   3.805575370788574
                  </td>
                 </tr>
                 <tr>
                  <td>
                   8683.3
                  </td>
                  <td>
                   51.20613098144531
                  </td>
                  <td>
                   0.08998948
                  </td>
                  <td>
                   3.3335282802581787
                  </td>
                 </tr>
                </table>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Now make it into a Spectrum1D instance.</span>
<span class="n">obs_orig</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">'wavelength'</span><span class="p">],</span> 
                 <span class="n">flux</span><span class="o">=</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">'flux'</span><span class="p">],</span> 
                 <span class="n">uncertainty</span><span class="o">=</span><span class="n">StdDevUncertainty</span><span class="p">(</span><span class="n">dataspec_sub</span><span class="p">[</span><span class="s1">'uncertainty'</span><span class="p">]))</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Change resolution of spectrum</span>
<span class="n">obs</span> <span class="o">=</span> <span class="n">gaussian_smooth</span><span class="p">(</span><span class="n">obs_orig</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Template</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">template_file</span><span class="p">)</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">2.E-5</span> <span class="o">*</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">unit</span> <span class="c1"># normalize template to a sensible range</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">'col1'</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> 
                      <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="p">[</span><span class="s1">'col2'</span><span class="p">]</span><span class="o">*</span><span class="n">factor</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
            </div>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Note that in this and in subsequent plots, we are showing just the wavelength range of</span>
<span class="c1"># interest. The template covers a significantly wider range.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Input data'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'Input data')
</pre>
               </div>
              </div>
              <img alt="../../_images/redshift_with_crosscorr_37_1.png" src="../../_images/redshift_with_crosscorr_37_1.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="id2">
           <h2>
            Preprocess Spectra
            <a class="headerlink" href="#id2" title="Permalink to this headline">
             #
            </a>
           </h2>
           <section id="id3">
            <h3>
             Subtract continuum
             <a class="headerlink" href="#id3" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span> 
<span class="n">p_obs</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>
<span class="n">continuum_model</span> <span class="o">=</span> <span class="n">continuum</span><span class="o">.</span><span class="n">fit_generic_continuum</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">Chebyshev1D</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> 
<span class="n">p_template</span> <span class="o">=</span> <span class="n">template</span> <span class="o">-</span> <span class="n">continuum_model</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'After continuum subtraction'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'After continuum subtraction')
</pre>
               </div>
              </div>
              <img alt="../../_images/redshift_with_crosscorr_40_1.png" src="../../_images/redshift_with_crosscorr_40_1.png"/>
             </div>
            </div>
           </section>
           <section id="id4">
            <h3>
             Smooth observed spectrum
             <a class="headerlink" href="#id4" title="Permalink to this headline">
              #
             </a>
            </h3>
            <div class="cell docutils container">
             <div class="cell_input docutils container">
              <div class="highlight-ipython3 notranslate">
               <div class="highlight">
                <pre><span></span><span class="c1"># Smooth data with sinc kernel</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># Cutoff frequency as a fraction of the sampling rate (in (0, 0.5)).</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.49</span>   <span class="c1"># Transition band, as a fraction of the sampling rate (in (0, 0.5)).</span>

<span class="c1"># The IRAF task uses the above values. Here, we try</span>
<span class="c1"># a much lower cutoff frequency to really dampen the</span>
<span class="c1"># high frequency structure in the observed spectrum.</span>
<span class="n">fc</span> <span class="o">=</span> <span class="mf">0.05</span> 

<span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">4</span> <span class="o">/</span> <span class="n">b</span><span class="p">)))</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># N must be odd</span>
    <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
 
<span class="c1"># Compute sinc filter and Blackman window. Multiply filter </span>
<span class="c1"># by window and normalize to get unity gain.</span>
<span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sinc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">fc</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">w</span> <span class="o">=</span> <span class="mf">0.42</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> \
    <span class="mf">0.08</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">filt</span> <span class="o">*=</span> <span class="n">w</span>
<span class="n">filt</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span>

<span class="c1"># Smooth</span>
<span class="n">p_obs_smoothed</span> <span class="o">=</span> <span class="n">convolution_smooth</span><span class="p">(</span><span class="n">p_obs</span><span class="p">,</span> <span class="n">filt</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_obs_smoothed</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_template</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">p_template</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'After smoothing'</span><span class="p">)</span>
</pre>
               </div>
              </div>
             </div>
             <div class="cell_output docutils container">
              <div class="output text_plain highlight-myst-ansi notranslate">
               <div class="highlight">
                <pre><span></span>Text(0.5, 1.0, 'After smoothing')
</pre>
               </div>
              </div>
              <img alt="../../_images/redshift_with_crosscorr_42_1.png" src="../../_images/redshift_with_crosscorr_42_1.png"/>
             </div>
            </div>
           </section>
          </section>
          <section id="id5">
           <h2>
            Cross correlate
            <a class="headerlink" href="#id5" title="Permalink to this headline">
             #
            </a>
           </h2>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">corr</span><span class="p">,</span> <span class="n">lag</span> <span class="o">=</span> <span class="n">correlation</span><span class="o">.</span><span class="n">template_correlate</span><span class="p">(</span><span class="n">p_obs_smoothed</span><span class="p">,</span> <span class="n">p_template</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lag</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">300000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Text(0.5, 0, 'km / s')
</pre>
              </div>
             </div>
             <img alt="../../_images/redshift_with_crosscorr_44_1.png" src="../../_images/redshift_with_crosscorr_44_1.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="c1"># Redshift based on maximum</span>
<span class="n">index_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">corr</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">'km/s'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Peak maximum at: "</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Redshift from peak maximum: "</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="c1"># Redshift based on parabolic fit to mazimum</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># points to the left or right of correlation maximum</span>

<span class="n">peak_lags</span> <span class="o">=</span> <span class="n">lag</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">peak_vals</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">index_peak</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="n">index_peak</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">peak_lags</span><span class="p">,</span> <span class="n">peak_vals</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">roots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roots</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="n">v_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span> <span class="c1"># maximum lies at mid point between roots</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">v_fit</span> <span class="o">/</span> <span class="n">const</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">'km/s'</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Parabolic fit with maximum at: "</span><span class="p">,</span> <span class="n">v_fit</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Redshift from parabolic fit: "</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Peak maximum at:  227330.87493846833 km / s
Redshift from peak maximum:  0.7582941760945445

Parabolic fit with maximum at:  227368.82804223686 km / s
Redshift from parabolic fit:  0.7584207740217296
</pre>
              </div>
             </div>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">z_ref</span> <span class="o">=</span> <span class="mf">0.758</span> <span class="c1"># "true" redshift, corresponding to 227242.6 km/s</span>

<span class="n">template_z</span> <span class="o">=</span> <span class="n">Spectrum1D</span><span class="p">(</span><span class="n">spectral_axis</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">z</span><span class="p">),</span> <span class="n">flux</span><span class="o">=</span><span class="n">template</span><span class="o">.</span><span class="n">flux</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">((</span><span class="mf">8.</span><span class="p">,</span><span class="mf">4.</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">sp_xlim</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'obs'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">template_z</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">template_z</span><span class="o">.</span><span class="n">flux</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'template'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Redshifted original template and original observed spectrum'</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output text_plain highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Text(0.5, 1.0, 'Redshifted original template and original observed spectrum')
</pre>
              </div>
             </div>
             <img alt="../../_images/redshift_with_crosscorr_46_1.png" src="../../_images/redshift_with_crosscorr_46_1.png"/>
            </div>
           </div>
           <div class="cell docutils container">
            <div class="cell_input docutils container">
             <div class="highlight-ipython3 notranslate">
              <div class="highlight">
               <pre><span></span><span class="n">z_err</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">z_ref</span><span class="p">)</span> <span class="o">/</span> <span class="n">z_ref</span> <span class="o">*</span> <span class="mf">100.</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Error in the derived redshift: "</span><span class="p">,</span> <span class="n">z_err</span><span class="p">,</span> <span class="s2">"%"</span><span class="p">)</span>
</pre>
              </div>
             </div>
            </div>
            <div class="cell_output docutils container">
             <div class="output stream highlight-myst-ansi notranslate">
              <div class="highlight">
               <pre><span></span>Error in the derived redshift:  0.05551108466089383 %
</pre>
              </div>
             </div>
            </div>
           </div>
          </section>
         </section>
         <script type="text/x-thebe-config">
          {
        requestKernel: true,
        binderOptions: {
            repo: "therealzoidberg/actions-ci-testing",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/redshift_crosscorr"
        },
        predefinedOutput: true
    }
         </script>
         <script>
          kernelName = 'python3'
         </script>
        </div>
       </main>
       <footer class="footer-article noprint">
        <!-- Previous / next buttons -->
        <div class="prev-next-area">
        </div>
       </footer>
      </div>
     </div>
     <div class="footer-content row">
      <footer class="col footer">
       <p>
        By STScI
        <br/>
        © Copyright 2022.
        <br/>
       </p>
       <div class="extra_footer">
        <div class="header">
         <div class="header content">
          <img alt="JWST Data Analysis Notebooks" class="logo" src="Jspectra.svg"/>
          <div class="search">
           <div class="searchbox">
           </div>
           <div class="searchbutton">
            Filter Notebooks
           </div>
          </div>
         </div>
        </div>
       </div>
      </footer>
     </div>
    </div>
   </div>
  </div>
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  </script>
 </body>
</html>